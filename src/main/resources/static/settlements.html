<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>룸메이트 - 정산 목록</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        min-height: 100vh;
      }

      .header {
        background: white;
        padding: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo h1 {
        color: #333;
        font-size: 24px;
      }

      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .nav-link {
        color: #333;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 6px;
        transition: background-color 0.2s ease;
      }

      .nav-link:hover {
        background-color: #f0f0f0;
      }

      .logout-btn {
        padding: 8px 16px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .main-content {
        max-width: 1200px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .page-title h2 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }

      .page-title p {
        color: #666;
        font-size: 16px;
      }

      .create-settlement-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .create-settlement-btn:hover {
        transform: translateY(-2px);
      }

      .settlements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .settlement-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .settlement-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .settlement-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .settlement-title {
        color: #333;
        font-size: 18px;
        font-weight: 600;
      }

      .settlement-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .status-completed {
        background: #d4edda;
        color: #155724;
      }

      .settlement-info {
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
      }

      .settlement-stats {
        display: flex;
        justify-content: space-between;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }

      .stat {
        text-align: center;
      }

      .stat-number {
        font-size: 20px;
        font-weight: 600;
        color: #667eea;
      }

      .stat-label {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error {
        text-align: center;
        padding: 40px;
        color: #e74c3c;
      }

      .back-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="header-content">
        <div class="logo">
          <h1>룸메이트</h1>
        </div>
        <div class="nav-links">
          <a href="#" class="nav-link" onclick="goBackToSpaces()"
            >스페이스 목록</a
          >
          <button class="logout-btn" onclick="logout()">로그아웃</button>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="page-header">
        <div class="page-title">
          <h2 id="spaceName">정산 목록</h2>
          <p>함께 정산할 항목들을 관리하세요</p>
        </div>
        <button class="create-settlement-btn" onclick="createSettlement()">
          새 정산 만들기
        </button>
      </div>

      <div id="settlementsContainer">
        <div class="loading">정산 목록을 불러오는 중...</div>
      </div>
    </div>

    <script>
      let currentSpaceId = null;
      let currentSpaceName = null;

      // 페이지 로드 시 정산 목록 가져오기
      document.addEventListener("DOMContentLoaded", function () {
        // URL에서 spaceId 파라미터 가져오기
        const urlParams = new URLSearchParams(window.location.search);
        currentSpaceId = urlParams.get("spaceId");

        if (!currentSpaceId) {
          alert("스페이스 ID가 없습니다.");
          window.location.href = "/spaces.html";
          return;
        }

        loadSpaceInfo();
        loadSettlements();
      });

      // 스페이스 정보 로드
      async function loadSpaceInfo() {
        try {
          const response = await fetch(`/api/spaces`, {
            credentials: "include",
          });

          if (response.ok) {
            const spaceData = await response.json();
            currentSpaceName = spaceData.name;
            document.getElementById(
              "spaceName"
            ).textContent = `${currentSpaceName} - 정산 목록`;
          }
        } catch (error) {
          console.error("스페이스 정보 로드 실패:", error);
        }
      }

      // 정산 목록 로드
      async function loadSettlements() {
        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/settlements`,
            {
              credentials: "include",
            }
          );

          if (response.ok) {
            const settlements = await response.json();
            displaySettlements(settlements);
          } else {
            document.getElementById("settlementsContainer").innerHTML =
              '<div class="error">정산 목록을 불러올 수 없습니다.</div>';
          }
        } catch (error) {
          document.getElementById("settlementsContainer").innerHTML =
            '<div class="error">서버 연결에 실패했습니다.</div>';
        }
      }

      // 정산 목록 표시
      function displaySettlements(settlements) {
        const container = document.getElementById("settlementsContainer");

        if (settlements.length === 0) {
          container.innerHTML =
            '<div class="error">아직 정산이 없습니다.</div>';
          return;
        }

        const settlementsHTML = settlements
          .map(
            (settlement) => `
                <div class="settlement-card" onclick="goToSettlementDetail(${
                  settlement.id
                })">
                    <div class="settlement-header">
                        <div class="settlement-title">${
                          settlement.title || "제목 없는 정산"
                        }</div>
                        <div class="settlement-status status-${settlement.status.toLowerCase()}">
                            ${getStatusText(settlement.status)}
                        </div>
                    </div>
                    <div class="settlement-info">
                        <p>생성일: ${new Date(
                          settlement.createdAt
                        ).toLocaleDateString()}</p>
                        ${
                          settlement.startDate
                            ? `<p>시작일: ${new Date(
                                settlement.startDate
                              ).toLocaleDateString()}</p>`
                            : ""
                        }
                        ${
                          settlement.endDate
                            ? `<p>완료일: ${new Date(
                                settlement.endDate
                              ).toLocaleDateString()}</p>`
                            : ""
                        }
                    </div>
                    <div class="settlement-stats">
                        <div class="stat">
                            <div class="stat-number">${formatCurrency(
                              settlement.totalAmount
                            )}</div>
                            <div class="stat-label">총 금액</div>
                        </div>
                        <div class="stat">
                            <div class="stat-number">${
                              settlement.expensesCount || 0
                            }</div>
                            <div class="stat-label">지출 항목</div>
                        </div>
                    </div>
                </div>
            `
          )
          .join("");

        container.innerHTML = settlementsHTML;
      }

      // 상태 텍스트 변환
      function getStatusText(status) {
        switch (status) {
          case "PENDING":
            return "진행중";
          case "COMPLETED":
            return "완료";
          default:
            return status;
        }
      }

      // 통화 포맷팅
      function formatCurrency(amount) {
        if (!amount) return "0원";
        return new Intl.NumberFormat("ko-KR").format(amount) + "원";
      }

      // 정산 상세 페이지로 이동
      function goToSettlementDetail(settlementId) {
        window.location.href = `/settlement-detail.html?spaceId=${currentSpaceId}&settlementId=${settlementId}`;
      }

      // 새 정산 생성
      async function createSettlement() {
        const title = prompt("정산 제목을 입력하세요:");
        if (!title) return;

        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/settlements`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                title: title,
              }),
            }
          );

          if (response.ok) {
            alert("정산이 생성되었습니다!");
            loadSettlements(); // 목록 새로고침
          } else {
            alert("정산 생성에 실패했습니다.");
          }
        } catch (error) {
          alert("서버 연결에 실패했습니다.");
        }
      }

      // 스페이스 목록으로 돌아가기
      function goBackToSpaces() {
        window.location.href = "/spaces.html";
      }

      // 로그아웃
      function logout() {
        // 로그아웃 API 호출 없이 바로 로그인 페이지로 이동
        window.location.href = "/login.html";
      }
    </script>
  </body>
</html>
