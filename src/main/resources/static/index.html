<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>룸메이트 테스트</title>
    <link rel="icon" href="data:," />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      .form-group {
        margin: 10px 0;
      }
      label {
        display: inline-block;
        width: 120px;
      }
      input,
      textarea {
        width: 200px;
        padding: 5px;
      }
      button {
        padding: 8px 15px;
        margin: 5px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        background: #f0f0f0;
      }
      .calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
      }
      .calendar-day {
        border: 1px solid #ddd;
        padding: 5px;
        min-height: 60px;
      }
      .calendar-day.has-events {
        background: #e6f3ff;
      }
      .event {
        font-size: 12px;
        margin: 2px 0;
      }
    </style>
  </head>
  <body>
    <h1>룸메이트 API 테스트</h1>

    <!-- 로그인/회원가입 -->
    <div class="section">
      <h2>로그인/회원가입</h2>
      <div class="form-group">
        <label>사용자명:</label>
        <input type="text" id="username" placeholder="사용자명 입력" />
        <button onclick="login()">로그인</button>
      </div>
      <div class="result" id="loginResult"></div>
    </div>

    <!-- 스페이스 생성 -->
    <div class="section">
      <h2>스페이스 생성</h2>
      <div class="form-group">
        <label>스페이스명:</label>
        <input type="text" id="spaceName" placeholder="스페이스 이름" />
        <button onclick="createSpace()">스페이스 생성</button>
      </div>
      <div class="result" id="createSpaceResult"></div>
    </div>

    <!-- 스페이스 입장 -->
    <div class="section">
      <h2>스페이스 입장</h2>
      <div class="form-group">
        <label>초대코드:</label>
        <input type="text" id="inviteCode" placeholder="초대코드 입력" />
        <button onclick="joinSpace()">스페이스 입장</button>
      </div>
      <div class="result" id="joinSpaceResult"></div>
    </div>

    <!-- 내 스페이스 정보 -->
    <div class="section">
      <h2>내 스페이스 정보</h2>
      <button onclick="getMySpace()">내 스페이스 조회</button>
      <div class="result" id="mySpaceResult"></div>
    </div>

    <!-- 일정 생성 -->
    <div class="section">
      <h2>일정 생성</h2>
      <div class="form-group">
        <label>제목:</label>
        <input type="text" id="eventTitle" placeholder="일정 제목" />
      </div>
      <div class="form-group">
        <label>내용:</label>
        <textarea id="eventContent" placeholder="일정 내용"></textarea>
      </div>
      <div class="form-group">
        <label>날짜:</label>
        <input type="date" id="eventDate" />
      </div>
      <button onclick="createCalendarEvent()">일정 생성</button>
      <div class="result" id="createEventResult"></div>
    </div>

    <!-- 일정 목록 -->
    <div class="section">
      <h2>일정 목록</h2>
      <button onclick="getEvents()">일정 목록 조회</button>
      <div class="result" id="eventsResult"></div>
    </div>

    <!-- 일별 일정 조회 -->
    <div class="section">
      <h2>일별 일정 조회</h2>
      <div class="form-group">
        <label>날짜:</label>
        <input type="date" id="dailyDate" />
        <button onclick="getDailyEvents()">해당 날짜 일정 조회</button>
      </div>
      <div class="result" id="dailyEventsResult"></div>
    </div>

    <!-- 월별 캘린더 -->
    <div class="section">
      <h2>월별 캘린더</h2>
      <div class="form-group">
        <label>년도:</label>
        <input type="number" id="calendarYear" value="2025" />
        <label>월:</label>
        <input type="number" id="calendarMonth" value="8" min="1" max="12" />
        <button onclick="getMonthlyCalendar()">캘린더 조회</button>
      </div>
      <div id="calendarResult"></div>
    </div>

    <script>
      let currentSpaceId = null;
      let currentUserId = null;

      // 로그인/회원가입
      async function login() {
        const username = document.getElementById("username").value;
        if (!username) {
          alert("사용자명을 입력하세요");
          return;
        }

        try {
          const response = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username }),
          });

          const result = await response.json();
          if (response.ok) {
            document.getElementById(
              "loginResult"
            ).innerHTML = `로그인 성공: ${result.username} (ID: ${result.userId})`;
            currentUserId = result.userId;
          } else {
            document.getElementById(
              "loginResult"
            ).innerHTML = `로그인 실패: ${result.message}`;
          }
        } catch (error) {
          document.getElementById(
            "loginResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 스페이스 생성
      async function createSpace() {
        const name = document.getElementById("spaceName").value;
        if (!name) {
          alert("스페이스 이름을 입력하세요");
          return;
        }

        try {
          const response = await fetch("/spaces", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name }),
          });

          const result = await response.json();
          if (response.ok) {
            document.getElementById(
              "createSpaceResult"
            ).innerHTML = `스페이스 생성 성공: ${result.name} (ID: ${result.id})`;
            currentSpaceId = result.id;
          } else {
            document.getElementById(
              "createSpaceResult"
            ).innerHTML = `생성 실패: ${result.message}`;
          }
        } catch (error) {
          document.getElementById(
            "createSpaceResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 스페이스 입장
      async function joinSpace() {
        const inviteCode = document.getElementById("inviteCode").value;
        if (!inviteCode) {
          alert("초대코드를 입력하세요");
          return;
        }

        try {
          const response = await fetch(
            `/spaces/join?inviteCode=${inviteCode}`,
            {
              method: "POST",
            }
          );

          const result = await response.json();
          if (response.ok) {
            document.getElementById(
              "joinSpaceResult"
            ).innerHTML = `입장 성공: ${result.name} (ID: ${result.id})`;
            currentSpaceId = result.id;
          } else {
            document.getElementById(
              "joinSpaceResult"
            ).innerHTML = `입장 실패: ${result.message}`;
          }
        } catch (error) {
          document.getElementById(
            "joinSpaceResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 내 스페이스 조회
      async function getMySpace() {
        try {
          const response = await fetch("/spaces/my");
          if (response.ok) {
            const result = await response.json();
            document.getElementById(
              "mySpaceResult"
            ).innerHTML = `스페이스: ${result.name} (ID: ${result.id})`;
            currentSpaceId = result.id;
          } else if (response.status === 404) {
            document.getElementById("mySpaceResult").innerHTML =
              "가입된 스페이스가 없습니다";
          } else {
            document.getElementById("mySpaceResult").innerHTML = "조회 실패";
          }
        } catch (error) {
          document.getElementById(
            "mySpaceResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 일정 생성
      async function createCalendarEvent() {
        if (!currentSpaceId) {
          alert("먼저 스페이스에 입장하세요");
          return;
        }

        const title = document.getElementById("eventTitle").value;
        const content = document.getElementById("eventContent").value;
        const date = document.getElementById("eventDate").value;

        if (!title || !date) {
          alert("제목과 날짜를 입력하세요");
          return;
        }

        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/calendars?userId=${currentUserId}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ title, content, date }),
            }
          );

          const result = await response.json();
          if (response.ok) {
            document.getElementById(
              "createEventResult"
            ).innerHTML = `일정 생성 성공: ${result.title}`;
            // 입력 필드 초기화
            document.getElementById("eventTitle").value = "";
            document.getElementById("eventContent").value = "";
            document.getElementById("eventDate").value = "";
          } else {
            document.getElementById(
              "createEventResult"
            ).innerHTML = `생성 실패: ${result.message}`;
          }
        } catch (error) {
          document.getElementById(
            "createEventResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 일정 목록 조회
      async function getEvents() {
        if (!currentSpaceId) {
          alert("먼저 스페이스에 입장하세요");
          return;
        }

        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/calendars`
          );
          if (response.ok) {
            const events = await response.json();
            let html = "<h3>일정 목록:</h3>";
            if (events.length === 0) {
              html += "<p>등록된 일정이 없습니다</p>";
            } else {
              events.forEach((event) => {
                html += `<div><strong>${event.title}</strong> - ${event.date} (${event.createdByUsername})</div>`;
              });
            }
            document.getElementById("eventsResult").innerHTML = html;
          } else {
            document.getElementById("eventsResult").innerHTML = "조회 실패";
          }
        } catch (error) {
          document.getElementById(
            "eventsResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 일별 일정 조회
      async function getDailyEvents() {
        if (!currentSpaceId) {
          alert("먼저 스페이스에 입장하세요");
          return;
        }

        const date = document.getElementById("dailyDate").value;
        if (!date) {
          alert("날짜를 선택하세요");
          return;
        }

        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/calendars/date/${date}`
          );
          if (response.ok) {
            const dailyEvents = await response.json();
            let html = `<h3>${date} 일정:</h3>`;
            if (dailyEvents.length === 0) {
              html += "<p>등록된 일정이 없습니다</p>";
            } else {
              dailyEvents.forEach((event) => {
                html += `<div><strong>${event.title}</strong> - ${event.date} (${event.createdByUsername})</div>`;
              });
            }
            document.getElementById("dailyEventsResult").innerHTML = html;
          } else {
            document.getElementById("dailyEventsResult").innerHTML =
              "조회 실패";
          }
        } catch (error) {
          document.getElementById(
            "dailyEventsResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 월별 캘린더 조회
      async function getMonthlyCalendar() {
        if (!currentSpaceId) {
          alert("먼저 스페이스에 입장하세요");
          return;
        }

        const year = document.getElementById("calendarYear").value;
        const month = document.getElementById("calendarMonth").value;

        try {
          const response = await fetch(
            `/api/spaces/${currentSpaceId}/calendars/month/${year}/${month}`
          );
          if (response.ok) {
            const calendarData = await response.json();
            displayCalendar(calendarData);
          } else {
            document.getElementById("calendarResult").innerHTML =
              "캘린더 조회 실패";
          }
        } catch (error) {
          document.getElementById(
            "calendarResult"
          ).innerHTML = `에러: ${error.message}`;
        }
      }

      // 캘린더 표시
      function displayCalendar(calendarData) {
        let html = `<h3>${calendarData.year}년 ${calendarData.month}월</h3>`;
        html += '<div class="calendar">';

        // 요일 헤더
        const days = ["일", "월", "화", "수", "목", "금", "토"];
        days.forEach((day) => {
          html += `<div class="calendar-day" style="text-align: center; font-weight: bold;">${day}</div>`;
        });

        // 날짜들
        calendarData.weeks.forEach((week) => {
          week.forEach((day) => {
            if (day.day === null) {
              html += '<div class="calendar-day"></div>';
            } else {
              const hasEvents = day.events && day.events.length > 0;
              const todayClass = day.isToday
                ? ' style="background: #ffeb3b;"'
                : "";
              const eventClass = hasEvents ? " has-events" : "";

              html += `<div class="calendar-day${eventClass}"${todayClass}>`;
              html += `<div>${day.day}</div>`;

              if (hasEvents) {
                day.events.forEach((event) => {
                  html += `<div class="event">${event.title}</div>`;
                });
              }
              html += "</div>";
            }
          });
        });

        html += "</div>";
        document.getElementById("calendarResult").innerHTML = html;
      }

      // 페이지 로드 시 오늘 날짜 설정
      window.onload = function () {
        const today = new Date();
        document.getElementById("eventDate").value = today
          .toISOString()
          .split("T")[0];
        document.getElementById("dailyDate").value = today
          .toISOString()
          .split("T")[0];
        document.getElementById("calendarYear").value = today.getFullYear();
        document.getElementById("calendarMonth").value = today.getMonth() + 1;
      };
    </script>
  </body>
</html>
